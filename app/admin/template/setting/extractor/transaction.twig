{% extends "_default/layout.base.twig" %}

{% import '_default/macro.base.twig' as base %}
{% import '_default/form.base.twig' as form %}

{% block content %}

	{% if action == 'edit' %}

		<ol class="breadcrumb">
			<li><a href="/">{% trans "Home" %}</a></li>
			<li><a href="/setting/extractor/transaction">{% trans "Transaction extractor" %}</a></li>
			<li class="active">{% trans "Edit transaction extractor" %}</li>
		</ol>

		{% if errors is defined %}
			<div class="alert alert-danger">
				{% trans "The form contains mistakes. Please correct them." %}
			</div>
		{% elseif env.sticky_session.message is defined %}
			{{ base.display_flash_message(env.sticky_session.message, 'extractor') }}
		{% endif %}

		<div class="card">
			<div class="card-header">
				{% trans "Details" %}
			</div>
			<div class="card-body">
				<form class="form form-horizontal form-condensed" method="post" action="/setting/extractor/transaction?action=edit&id={{ extractor.id }}">

					<div class="row mb-3{% if 'name' in errors|keys %} has-error{% endif %}">
						<label for="name" class="col-form-label col-3 text-end">{% trans "Name" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[name]" id="name" class="form-control" value="{{ extractor.name }}">
							{{ form.invalid_input('name', errors) }}
						</div>
					</div>

					<div class="row mb-3{% if 'fingerprint_message' in errors|keys %} has-error{% endif %}">
						<label for="fingerprint_message" class="col-form-label col-3 text-end">{% trans "Message contains" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[fingerprint_message]" id="fingerprint_message" class="form-control" value="{{ extractor.fingerprint_message }}">
							{{ form.invalid_input('fingerprint_message', errors) }}
						</div>
					</div>

					<div class="row mb-3{% if 'fingerprint_other_account_name' in errors|keys %} has-error{% endif %}">
						<label for="fingerprint_other_account_name" class="col-form-label col-3 text-end">{% trans "Other name contains" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[fingerprint_other_account_name]" id="fingerprint_other_account_name" class="form-control" value="{{ extractor.fingerprint_other_account_name }}">
							{{ form.invalid_input('fingerprint_other_account_name', errors) }}
						</div>
					</div>

					<div class="row mb-3{% if 'fingerprint_other_account_number' in errors|keys %} has-error{% endif %}">
						<label for="fingerprint_other_account_number" class="col-form-label col-3 text-end">{% trans "Other account number contains" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[fingerprint_other_account_number]" id="fingerprint_other_account_number" class="form-control" value="{{ extractor.fingerprint_other_account_number }}">
							{{ form.invalid_input('fingerprint_other_account_number', errors) }}
						</div>
					</div>

					<div class="row mb-3">
						<div class="col-3 offset-3">
							<button class="btn btn-primary">
								{% trans "Save" %}
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		<div class="row">
			<div class="col-6">
				<div class="card">
					<div class="card-header">{% trans "Transaction information" %}</div>
					<div class="card-body">
						{% if extractor.bank_account_statement_transaction_id > 0 %}
							<pre>{{ extractor.bank_account_statement_transaction|print_r }}</pre>
						{% else %}
							<pre>{% trans "No transaction given" %}</pre>
						{% endif %}
					</div>
				</div>
			</div>

			<div class="col-6">
				<div class="alert alert-info">
					<p>
					{% trans "Variable $transaction is available." %} {% trans "Please use"%} <b>$transaction->add_link($object, $amount);</b> {% trans "to link the transaction amount to the object." %}
					</p>
					<p>{% trans "More than one link can be made." %} {% trans "Objects should be of type 'Invoice', 'Supplier', 'Bookkeeping_Account', 'Supplier' or 'Customer_Contact'." %}
					</p>
					{% trans "If no link is possible, return false" %}
				</div>
				<div class="alert alert-danger hide" id="eval_error"></div>
				<div class="row mb-3">
					<textarea class="form-control autogrow code" id="eval">{{ extractor.eval }}</textarea>
				</div>
				<div class="row mb-3">
					<button type="button" class="btn btn-primary" onclick="run_eval();">{% trans "Run" %}</button>
				</div>

				<div class="row mb-3 hide" id="parsed_content">
					<div class="card">
						<div class="card-header">{% trans "Data" %}</div>
						<div class="card-body" id="data"></div>
					</div>

					<div class="card">
						<div class="card-header">{% trans "Output" %}</div>
						<div class="card-body" id="output"></div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			function run_eval() {
				data = {
					'eval': editor.getValue()
				}
				$.post('/setting/extractor/transaction?action=eval&id={{ extractor.id }}', data, function(response) {
					$("#eval_error").addClass('hide');
					$('#data').html('');
					$('#output').html('');
					if (response.error) {
						$("#eval_error").html(response.message);
						$("#eval_error").removeClass('hide');
						$('#output').html('');
					} else {
						$('#output').html('<pre>' + response.message + '</pre>');
						var table = $('<table/>').addClass('table').addClass('table-alternate');

						$.each(response.data, function(key, value) {
							table.append('<tr><th>' + value.classname + '</th><td>' + value.id + '</td><td>' + value.amount + '</td></tr>');
						})

						$('#data').append(table);

					}
					$('#parsed_content').removeClass('hide');
				}, 'json');
			}



			editor = CodeMirror.fromTextArea(document.getElementById("eval"), {
				lineNumbers: true,
				mode: "application/x-httpd-php-open",
				indentUnit: 4,
				indentWithTabs: true
			});

			$(document).ready(function() {
				$('input[name="extractor[fingerprint_other_account_number]"]').mask('SSAA AAAA 0000 0000 0000 0000 0000', { placeholder: '____ ____ ____ ____ ____ ____ ____'  });
			});

		</script>

	{% elseif action == 'add' %}

		<ol class="breadcrumb">
			<li><a href="/">{% trans "Home" %}</a></li>
			<li><a href="/setting/extractor/transaction">{% trans "Transaction extractor" %}</a></li>
			<li class="active">{% trans "Add transaction extractor" %}</li>
		</ol>

		{% if errors is defined %}
			<div class="alert alert-danger">
				{% trans "The form contains mistakes. Please correct them." %}
			</div>
		{% endif %}

		<div class="card">
			<div class="card-header">
				{% trans "Details" %}
			</div>
			<div class="card-body">
				<form class="form form-horizontal form-condensed" method="post" action="/setting/extractor/transaction?action=add">
					<input type="hidden" name="extractor[bank_account_statement_transaction_id]" value="{{ transaction.id }}" />
					<div class="alert alert-info">
						{% trans "You are about to create an extractor for the following bank account transaction" %}:
					</div>

					<div class="row mb-3">
						<label class="col-form-label col-3 text-end">{% trans "Transaction to" %}</label>
						<div class="col-9"><p class="form-control-static">{{ transaction.other_account_name }}</div>
					</div>

					<div class="row mb-3">
						<label class="col-form-label col-3 text-end">{% trans "Account number" %}</label>
						<div class="col-9"><p class="form-control-static">{{ transaction.other_account_number|iban_to_human_format }}</div>
					</div>

					<div class="row mb-3">
						<label class="col-form-label col-3 text-end">{% trans "Transaction message" %}</label>
						<div class="col-9"><p class="form-control-static">
						{% if transaction.structured_message != '' %}{{ transaction.structured_message }}{% else %}{{ transaction.message }}{% endif %}
						</div>
					</div>

					<div class="row mb-3">
						<label class="col-form-label col-3 text-end">{% trans "Amount" %}</label>
						<div class="col-9"><p class="form-control-static">&euro;{{ transaction.amount }}</div>
					</div>

					<hr />

					<div class="row mb-3{% if 'name' in errors|keys %} has-error{% endif %}">
						<label for="name" class="col-form-label col-3 text-end">{% trans "Name" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[name]" id="name" class="form-control" value="{{ env.post.extractor.name }}">
							{{ form.invalid_input('name', errors) }}
						</div>
					</div>

					<div class="row mb-3{% if 'fingerprint_message' in errors|keys %} has-error{% endif %}">
						<label for="fingerprint_message" class="col-form-label col-3 text-end">{% trans "Message contains" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[fingerprint_message]" id="fingerprint_message" class="form-control" value="{{ env.post.extractor.fingerprint_message }}">
							{{ form.invalid_input('fingerprint_message', errors) }}
						</div>
					</div>

					<div class="row mb-3{% if 'fingerprint_other_account_name' in errors|keys %} has-error{% endif %}">
						<label for="fingerprint_other_account_name" class="col-form-label col-3 text-end">{% trans "Other name contains" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[fingerprint_other_account_name]" id="fingerprint_other_account_name" class="form-control" value="{{ env.post.extractor.fingerprint_other_account_name }}">
							{{ form.invalid_input('fingerprint_other_account_name', errors) }}
						</div>
					</div>

					<div class="row mb-3{% if 'fingerprint_other_account_number' in errors|keys %} has-error{% endif %}">
						<label for="fingerprint_other_account_number" class="col-form-label col-3 text-end">{% trans "Other account number contains" %}</label>
						<div class="col-9">
							<input type="text" name="extractor[fingerprint_other_account_number]" id="fingerprint_other_account_number" class="form-control" value="{{ env.post.extractor.fingerprint_other_account_number }}">
							{{ form.invalid_input('fingerprint_other_account_number', errors) }}
						</div>
					</div>

					<div class="row mb-3">
						<div class="col-3 offset-3">
							<button class="btn btn-primary">
								{% trans "Save" %}
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		<script type="text/javascript">
			$(document).ready(function() {
				$('input[name="extractor[fingerprint_other_account_name]"]').mask('SSAA AAAA 0000 0000 0000 0000 0000', { placeholder: '____ ____ ____ ____ ____ ____ ____'  });
			});
		</script>

	{% else %}

		<ol class="breadcrumb">
			<li><a href="/">{% trans "Home" %}</a></li>
			<li class="active">{% trans "Extractors" %}</li>
		</ol>

		{% if env.sticky_session.message is defined %}
			{{ base.display_flash_message(env.sticky_session.message, 'extractor') }}
		{% endif %}

		<div class="card">
			<div class="card-header">
				{% trans "Filter" %}
			</div>
			<div class="card-body">
				<form method="post" action="/setting/extractor/transaction" class="form-horizontal">
					<div class="row mb-3">
						<label class="col-form-label col-3 text-end">{% trans "Search" %}</label>
						<div class="col-5">
							<input type="text" name="search" class="form-control" value="{{ pager.get_search() }}">
						</div>
					</div>
					<div class="row mb-3">
						<div class="col-3 offset-3">
							<button class="btn btn-primary">
								{% trans "Search" %}
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		<div class="card">
			<div class="card-header">
				{{ base.pager_count(pager.item_count) }}
			</div>
			<div class="card-body">
			{% for extractor in pager.items %}
				{% if loop.first %}
					<table class="table table-hover table-striped table-condensed table-responsive">
					<thead>
						<tr>
							<th width="40">{{ pager.create_header('ID'|trans, 'id')|raw }}</th>
							<th>{{ pager.create_header('Name'|trans, 'name')|raw }}</th>
							<th>{{ pager.create_header('Last used'|trans, 'last_used')|raw }}</th>
							<th width="30">&nbsp;</th>
							<th width="30">&nbsp;</th>
						</tr>
					</thead>
					<tbody>
				{% endif %}

					<tr>
						<td>{{ extractor.id }}</td>
						<td>{{ extractor.name }}</td>
						<td>
							{% if extractor.last_used is null %}
								<i>{% trans "Never" %}</i>
							{% else %}
								{{ extractor.last_used|datetime }}
							{% endif %}
						</td>

						<td>
							<a href="/setting/extractor/transaction?action=edit&id={{ extractor.id }}" title="">
								<i data-feather="edit"></i>
							</a>
						</td>
						<td>
							<a href="/setting/extractor/transaction?id={{ extractor.id }}&action=delete" data-confirm-title="{% trans "Please confirm" %}" data-confirm-message="{% trans "Are you sure you want to remove this extractor?" %}">
								<i data-feather="trash-2"></i>
							</a>
						</td>
					</tr>

				{% if loop.last %}
					</tbody>
					</table>
					{{ pager.links|raw }}
				{% endif %}
			{% endfor %}
			</div>
		</div>

	{% endif %}

{% endblock content %}
